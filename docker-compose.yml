version: "3.8"

services:
  # Backend API Service
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: saas-menu-api:latest
    container_name: saas-menu-api
    restart: unless-stopped
    ports:
      - "4021:4021"

    # Environment variables
    environment:
      NODE_ENV: development
      PORT: 4021

      # Database (SQL Server)
      DB_HOST: 172.96.141.4
      DB_PORT: ${DB_PORT:-1433}
      DB_NAME: SaasMenu
      DB_USER: sa
      DB_PASSWORD: M@m12301230

      # JWT Secrets
      JWT_ACCESS_SECRET: b9424e56c75b73ded98ff4e216a6458b3e203b86155f7644989b24020b9ebdadae1ac1e79144d8eb8c5f359eac07e879d0ae00bdee32d0e35e4d03069f1866fc
      JWT_REFRESH_SECRET: 5e6410082e430a54bf8c9a17976bc85d9e512452956ee7419fd5fd5fdbed3a573e6291223a40fa74623e4d89ac7584102e57af644614ef6012d34bac8756eb10
      JWT_ACCESS_EXPIRY: ${JWT_ACCESS_EXPIRY:-15m}
      JWT_REFRESH_EXPIRY: ${JWT_REFRESH_EXPIRY:-7d}

      # Frontend URL (CORS)
      FRONTEND_URL: https://ensmenu.com

    # Persistent volumes
    volumes:
      - uploads:/app/uploads
      - logs:/app/logs

    # Health check
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:4021/health",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M

    # Network
    networks:
      - app-network

# Named volumes for persistence
volumes:
  uploads:
    driver: local
  logs:
    driver: local

# Network
networks:
  app-network:
    driver: bridge
